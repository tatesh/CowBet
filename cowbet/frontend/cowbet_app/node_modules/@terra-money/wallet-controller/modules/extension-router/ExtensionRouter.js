import { WebExtensionStatus, } from '@terra-money/web-extension-interface';
import { BehaviorSubject } from 'rxjs';
import { isDesktopChrome } from '../../utils/browser-check';
import { LegacyExtensionConnector } from '../legacy-extension';
import { selectModal } from './modal';
import { getTerraExtensions } from './multiChannel';
import { clearSession, getStoredSession, storeSession } from './session';
import { ExtensionRouterConnectorType, ExtensionRouterStatus, } from './types';
export class ExtensionRouter {
    constructor(options) {
        var _a, _b;
        this.options = options;
        this._connector = null;
        // ---------------------------------------------
        // states
        // ---------------------------------------------
        this.states = () => {
            return this._states.asObservable();
        };
        this.getLastStates = () => {
            return this._states.getValue();
        };
        // ---------------------------------------------
        // behaviors
        // ---------------------------------------------
        this.connect = async (identifier) => {
            var _a;
            const extensionInfos = getTerraExtensions();
            if (extensionInfos.length === 0) {
                throw new Error(`[ExtensionRouter] Can't find connectors`);
            }
            let extensionInfo;
            if (identifier) {
                extensionInfo = extensionInfos.find((item) => item.identifier === identifier);
            }
            else if (extensionInfos.length === 1) {
                extensionInfo = extensionInfos[0];
            }
            else {
                const select = (_a = this.options.selectExtension) !== null && _a !== void 0 ? _a : selectModal;
                const selectedExtensionInfo = await select(extensionInfos);
                if (selectedExtensionInfo) {
                    extensionInfo = selectedExtensionInfo;
                }
            }
            if (extensionInfo) {
                this.createConnector(extensionInfo);
            }
        };
        this.disconnect = () => {
            var _a;
            clearSession();
            this._states.next({
                type: ExtensionRouterStatus.WALLET_NOT_CONNECTED,
                network: this.options.defaultNetwork,
            });
            (_a = this._connector) === null || _a === void 0 ? void 0 : _a.close();
            this._connector = null;
        };
        this.requestApproval = () => {
            if (!this._connector) {
                throw new Error('[ExtensionRouter] No connector');
            }
            this._connector.requestApproval();
        };
        this.refetchStates = () => {
            if (!this._connector) {
                throw new Error('[ExtensionRouter] No connector');
            }
            this._connector.refetchStates();
        };
        this.post = (tx, terraAddress) => {
            if (!this._connector) {
                throw new Error('[ExtensionRouter] No connector');
            }
            const latestStates = this.getLastStates();
            if (latestStates.type !== ExtensionRouterStatus.WALLET_CONNECTED) {
                throw new Error(`[ExtensionRouter] Wallet is not connected`);
            }
            return this._connector.post(terraAddress !== null && terraAddress !== void 0 ? terraAddress : latestStates.wallet.terraAddress, tx);
        };
        this.sign = (tx, terraAddress) => {
            if (!this._connector) {
                throw new Error('[ExtensionRouter] No connector');
            }
            const latestStates = this.getLastStates();
            if (latestStates.type !== ExtensionRouterStatus.WALLET_CONNECTED) {
                throw new Error(`[ExtensionRouter] Wallet is not connected`);
            }
            return this._connector.sign(terraAddress !== null && terraAddress !== void 0 ? terraAddress : latestStates.wallet.terraAddress, tx);
        };
        this.signBytes = (bytes, terraAddress) => {
            if (!this._connector) {
                throw new Error('[ExtensionRouter] No connector');
            }
            const latestStates = this.getLastStates();
            if (latestStates.type !== ExtensionRouterStatus.WALLET_CONNECTED) {
                throw new Error(`[ExtensionRouter] Wallet is not connected`);
            }
            return this._connector.signBytes(terraAddress !== null && terraAddress !== void 0 ? terraAddress : latestStates.wallet.terraAddress, bytes);
        };
        this.hasCW20Tokens = (chainID, ...tokenAddrs) => {
            if (!this._connector) {
                throw new Error('[ExtensionRouter] No connector');
            }
            else if (this._connector instanceof LegacyExtensionConnector) {
                throw new Error('[ExtensionRouter] Legacy extension does not support hasCW20Tokens() ');
            }
            return this._connector.hasCW20Tokens(chainID, ...tokenAddrs);
        };
        this.addCW20Tokens = (chainID, ...tokenAddrs) => {
            if (!this._connector) {
                throw new Error('[ExtensionRouter] No connector');
            }
            else if (this._connector instanceof LegacyExtensionConnector) {
                throw new Error('[ExtensionRouter] Legacy extension does not support addCW20Tokens() ');
            }
            return this._connector.addCW20Tokens(chainID, ...tokenAddrs);
        };
        this.hasNetwork = (network) => {
            if (!this._connector) {
                throw new Error('[ExtensionRouter] No connector');
            }
            else if (this._connector instanceof LegacyExtensionConnector) {
                throw new Error('[ExtensionRouter] Legacy extension does not support hasNetwork() ');
            }
            return this._connector.hasNetwork(network);
        };
        this.addNetwork = (network) => {
            if (!this._connector) {
                throw new Error('[ExtensionRouter] No connector');
            }
            else if (this._connector instanceof LegacyExtensionConnector) {
                throw new Error('[ExtensionRouter] Legacy extension does not support addNetwork() ');
            }
            return this._connector.addNetwork(network);
        };
        // ---------------------------------------------
        // internal
        // ---------------------------------------------
        this.createConnector = (extensionInfo) => {
            var _a;
            (_a = this._connector) === null || _a === void 0 ? void 0 : _a.close();
            if (!extensionInfo.connector && !this.isDesktopChrome) {
                throw new Error(`[ExtensionRouter] Legacy extension only support the desktop chrome`);
            }
            const connectorPromise = extensionInfo.connector
                ? Promise.resolve(extensionInfo.connector())
                : Promise.resolve(new LegacyExtensionConnector(extensionInfo.identifier));
            connectorPromise.then((connector) => {
                var _a;
                connector.open((_a = this.options.hostWindow) !== null && _a !== void 0 ? _a : window, {
                    next: (nextStates) => {
                        var _a;
                        if (nextStates.type === WebExtensionStatus.INITIALIZING) {
                            this._states.next({
                                type: ExtensionRouterStatus.INITIALIZING,
                                network: this.options.defaultNetwork,
                            });
                        }
                        else if (nextStates.type === WebExtensionStatus.NO_AVAILABLE) {
                            this._states.next({
                                type: ExtensionRouterStatus.NO_AVAILABLE,
                                network: this.options.defaultNetwork,
                                isConnectorExists: true,
                                isApproved: nextStates.isApproved,
                            });
                        }
                        else if (nextStates.wallets.length === 0) {
                            this._states.next({
                                type: ExtensionRouterStatus.WALLET_NOT_CONNECTED,
                                network: nextStates.network,
                            });
                        }
                        else {
                            this._states.next({
                                type: ExtensionRouterStatus.WALLET_CONNECTED,
                                network: nextStates.network,
                                wallet: nextStates.focusedWalletAddress
                                    ? (_a = nextStates.wallets.find((itemWallet) => itemWallet.terraAddress ===
                                        nextStates.focusedWalletAddress)) !== null && _a !== void 0 ? _a : nextStates.wallets[0]
                                    : nextStates.wallets[0],
                                connectorType: connector instanceof LegacyExtensionConnector
                                    ? ExtensionRouterConnectorType.LEGACY
                                    : ExtensionRouterConnectorType.WEB_EXTENSION,
                                supportFeatures: new Set(connector.supportFeatures()),
                                extensionInfo,
                            });
                        }
                    },
                    error: (error) => {
                        console.error(error);
                    },
                    complete: () => { },
                });
                this._connector = connector;
                storeSession({
                    identifier: extensionInfo.identifier,
                });
            });
        };
        this.isDesktopChrome =
            typeof window !== 'undefined' &&
                isDesktopChrome((_b = (_a = options.dangerously__chromeExtensionCompatibleBrowserCheck) === null || _a === void 0 ? void 0 : _a.call(options, navigator.userAgent)) !== null && _b !== void 0 ? _b : false);
        this._states = new BehaviorSubject({
            type: ExtensionRouterStatus.INITIALIZING,
            network: options.defaultNetwork,
        });
        this._extensionInfos = getTerraExtensions();
        if (this._extensionInfos.length === 0) {
            this._states.next({
                type: ExtensionRouterStatus.NO_AVAILABLE,
                network: options.defaultNetwork,
                isConnectorExists: false,
            });
            return;
        }
        // ---------------------------------------------
        // initialize session
        // ---------------------------------------------
        const session = getStoredSession();
        if (session) {
            const extensionInfo = this._extensionInfos.find((item) => item.identifier === session.identifier);
            if (extensionInfo) {
                this.createConnector(extensionInfo);
                return;
            }
            else {
                console.warn(`Can't find an extension for the session "${session.identifier}"`);
                clearSession();
                this._states.next({
                    type: ExtensionRouterStatus.WALLET_NOT_CONNECTED,
                    network: options.defaultNetwork,
                });
            }
        }
        else {
            this._states.next({
                type: ExtensionRouterStatus.WALLET_NOT_CONNECTED,
                network: options.defaultNetwork,
            });
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXh0ZW5zaW9uUm91dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL0B0ZXJyYS1tb25leS93YWxsZXQtY29udHJvbGxlci9tb2R1bGVzL2V4dGVuc2lvbi1yb3V0ZXIvRXh0ZW5zaW9uUm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFPTCxrQkFBa0IsR0FFbkIsTUFBTSxzQ0FBc0MsQ0FBQztBQUU5QyxPQUFPLEVBQUUsZUFBZSxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUNyRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDNUQsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN0QyxPQUFPLEVBQWlCLGtCQUFrQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkUsT0FBTyxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxZQUFZLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDekUsT0FBTyxFQUNMLDRCQUE0QixFQUU1QixxQkFBcUIsR0FDdEIsTUFBTSxTQUFTLENBQUM7QUFrQmpCLE1BQU0sT0FBTyxlQUFlO0lBUTFCLFlBQTZCLE9BQStCOztRQUEvQixZQUFPLEdBQVAsT0FBTyxDQUF3QjtRQUpwRCxlQUFVLEdBQXNDLElBQUksQ0FBQztRQThEN0QsZ0RBQWdEO1FBQ2hELFNBQVM7UUFDVCxnREFBZ0Q7UUFDaEQsV0FBTSxHQUFHLEdBQUcsRUFBRTtZQUNaLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNyQyxDQUFDLENBQUM7UUFFRixrQkFBYSxHQUFHLEdBQUcsRUFBRTtZQUNuQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDakMsQ0FBQyxDQUFDO1FBRUYsZ0RBQWdEO1FBQ2hELFlBQVk7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O1NBQ1I7UUFFRCxnREFBZ0Q7UUFDaEQscUJBQXFCO1FBQ3JCLGdEQUFnRDtRQUNoRCxNQUFNLE9BQU8sR0FBRyxnQkFBZ0IsRUFBRSxDQUFDO1FBRW5DLElBQUksT0FBTyxFQUFFO1lBQ1gsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQzdDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxLQUFLLE9BQU8sQ0FBQyxVQUFVLENBQ2pELENBQUM7WUFFRixJQUFJLGFBQWEsRUFBRTtnQkFDakIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxhQUFhLENBQUMsQ0FBQztnQkFDcEMsT0FBTzthQUNSO2lCQUFNO2dCQUNMLE9BQU8sQ0FBQyxJQUFJLENBQ1YsNENBQTRDLE9BQU8sQ0FBQyxVQUFVLEdBQUcsQ0FDbEUsQ0FBQztnQkFDRixZQUFZLEVBQUUsQ0FBQztnQkFFZixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztvQkFDaEIsSUFBSSxFQUFFLHFCQUFxQixDQUFDLG9CQUFvQjtvQkFDaEQsT0FBTyxFQUFFLE9BQU8sQ0FBQyxjQUFjO2lCQUNoQyxDQUFDLENBQUM7YUFDSjtTQUNGO2FBQU07WUFDTCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztnQkFDaEIsSUFBSSxFQUFFLHFCQUFxQixDQUFDLG9CQUFvQjtnQkFDaEQsT0FBTyxFQUFFLE9BQU8sQ0FBQyxjQUFjO2FBQ2hDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztDQXFRRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5ldHdvcmtJbmZvIH0gZnJvbSAnQHRlcnJhLW1vbmV5L3dhbGxldC10eXBlcyc7XG5pbXBvcnQge1xuICBUZXJyYVdlYkV4dGVuc2lvbkNvbm5lY3RvcixcbiAgV2ViRXh0ZW5zaW9uTmV0d29ya0luZm8sXG4gIFdlYkV4dGVuc2lvblBvc3RQYXlsb2FkLFxuICBXZWJFeHRlbnNpb25TaWduQnl0ZXNQYXlsb2FkLFxuICBXZWJFeHRlbnNpb25TaWduUGF5bG9hZCxcbiAgV2ViRXh0ZW5zaW9uU3RhdGVzLFxuICBXZWJFeHRlbnNpb25TdGF0dXMsXG4gIFdlYkV4dGVuc2lvblR4UmVzdWx0LFxufSBmcm9tICdAdGVycmEtbW9uZXkvd2ViLWV4dGVuc2lvbi1pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQ3JlYXRlVHhPcHRpb25zIH0gZnJvbSAnQHRlcnJhLW1vbmV5L3RlcnJhLmpzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgU3Vic2NyaWJhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBpc0Rlc2t0b3BDaHJvbWUgfSBmcm9tICcuLi8uLi91dGlscy9icm93c2VyLWNoZWNrJztcbmltcG9ydCB7IExlZ2FjeUV4dGVuc2lvbkNvbm5lY3RvciB9IGZyb20gJy4uL2xlZ2FjeS1leHRlbnNpb24nO1xuaW1wb3J0IHsgc2VsZWN0TW9kYWwgfSBmcm9tICcuL21vZGFsJztcbmltcG9ydCB7IEV4dGVuc2lvbkluZm8sIGdldFRlcnJhRXh0ZW5zaW9ucyB9IGZyb20gJy4vbXVsdGlDaGFubmVsJztcbmltcG9ydCB7IGNsZWFyU2Vzc2lvbiwgZ2V0U3RvcmVkU2Vzc2lvbiwgc3RvcmVTZXNzaW9uIH0gZnJvbSAnLi9zZXNzaW9uJztcbmltcG9ydCB7XG4gIEV4dGVuc2lvblJvdXRlckNvbm5lY3RvclR5cGUsXG4gIEV4dGVuc2lvblJvdXRlclN0YXRlcyxcbiAgRXh0ZW5zaW9uUm91dGVyU3RhdHVzLFxufSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGludGVyZmFjZSBFeHRlbnNpb25Sb3V0ZXJPcHRpb25zIHtcbiAgZGVmYXVsdE5ldHdvcms6IE5ldHdvcmtJbmZvO1xuICBzZWxlY3RFeHRlbnNpb24/OiAoXG4gICAgZXh0ZW5zaW9uSW5mb3M6IEV4dGVuc2lvbkluZm9bXSxcbiAgKSA9PiBQcm9taXNlPEV4dGVuc2lvbkluZm8gfCBudWxsPjtcblxuICBob3N0V2luZG93PzogV2luZG93O1xuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBkZXZlbG9wbWVudCBmZWF0dXJlc1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgZGFuZ2Vyb3VzbHlfX2Nocm9tZUV4dGVuc2lvbkNvbXBhdGlibGVCcm93c2VyQ2hlY2s6IChcbiAgICB1c2VyQWdlbnQ6IHN0cmluZyxcbiAgKSA9PiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgRXh0ZW5zaW9uUm91dGVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBfc3RhdGVzOiBCZWhhdmlvclN1YmplY3Q8RXh0ZW5zaW9uUm91dGVyU3RhdGVzPjtcbiAgcHJpdmF0ZSByZWFkb25seSBfZXh0ZW5zaW9uSW5mb3M6IEV4dGVuc2lvbkluZm9bXTtcblxuICBwcml2YXRlIF9jb25uZWN0b3I6IFRlcnJhV2ViRXh0ZW5zaW9uQ29ubmVjdG9yIHwgbnVsbCA9IG51bGw7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBpc0Rlc2t0b3BDaHJvbWU6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBvcHRpb25zOiBFeHRlbnNpb25Sb3V0ZXJPcHRpb25zKSB7XG4gICAgdGhpcy5pc0Rlc2t0b3BDaHJvbWUgPVxuICAgICAgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICAgIGlzRGVza3RvcENocm9tZShcbiAgICAgICAgb3B0aW9ucy5kYW5nZXJvdXNseV9fY2hyb21lRXh0ZW5zaW9uQ29tcGF0aWJsZUJyb3dzZXJDaGVjaz8uKFxuICAgICAgICAgIG5hdmlnYXRvci51c2VyQWdlbnQsXG4gICAgICAgICkgPz8gZmFsc2UsXG4gICAgICApO1xuXG4gICAgdGhpcy5fc3RhdGVzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxFeHRlbnNpb25Sb3V0ZXJTdGF0ZXM+KHtcbiAgICAgIHR5cGU6IEV4dGVuc2lvblJvdXRlclN0YXR1cy5JTklUSUFMSVpJTkcsXG4gICAgICBuZXR3b3JrOiBvcHRpb25zLmRlZmF1bHROZXR3b3JrLFxuICAgIH0pO1xuXG4gICAgdGhpcy5fZXh0ZW5zaW9uSW5mb3MgPSBnZXRUZXJyYUV4dGVuc2lvbnMoKTtcblxuICAgIGlmICh0aGlzLl9leHRlbnNpb25JbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuX3N0YXRlcy5uZXh0KHtcbiAgICAgICAgdHlwZTogRXh0ZW5zaW9uUm91dGVyU3RhdHVzLk5PX0FWQUlMQUJMRSxcbiAgICAgICAgbmV0d29yazogb3B0aW9ucy5kZWZhdWx0TmV0d29yayxcbiAgICAgICAgaXNDb25uZWN0b3JFeGlzdHM6IGZhbHNlLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBpbml0aWFsaXplIHNlc3Npb25cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICBjb25zdCBzZXNzaW9uID0gZ2V0U3RvcmVkU2Vzc2lvbigpO1xuXG4gICAgaWYgKHNlc3Npb24pIHtcbiAgICAgIGNvbnN0IGV4dGVuc2lvbkluZm8gPSB0aGlzLl9leHRlbnNpb25JbmZvcy5maW5kKFxuICAgICAgICAoaXRlbSkgPT4gaXRlbS5pZGVudGlmaWVyID09PSBzZXNzaW9uLmlkZW50aWZpZXIsXG4gICAgICApO1xuXG4gICAgICBpZiAoZXh0ZW5zaW9uSW5mbykge1xuICAgICAgICB0aGlzLmNyZWF0ZUNvbm5lY3RvcihleHRlbnNpb25JbmZvKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgIGBDYW4ndCBmaW5kIGFuIGV4dGVuc2lvbiBmb3IgdGhlIHNlc3Npb24gXCIke3Nlc3Npb24uaWRlbnRpZmllcn1cImAsXG4gICAgICAgICk7XG4gICAgICAgIGNsZWFyU2Vzc2lvbigpO1xuXG4gICAgICAgIHRoaXMuX3N0YXRlcy5uZXh0KHtcbiAgICAgICAgICB0eXBlOiBFeHRlbnNpb25Sb3V0ZXJTdGF0dXMuV0FMTEVUX05PVF9DT05ORUNURUQsXG4gICAgICAgICAgbmV0d29yazogb3B0aW9ucy5kZWZhdWx0TmV0d29yayxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3N0YXRlcy5uZXh0KHtcbiAgICAgICAgdHlwZTogRXh0ZW5zaW9uUm91dGVyU3RhdHVzLldBTExFVF9OT1RfQ09OTkVDVEVELFxuICAgICAgICBuZXR3b3JrOiBvcHRpb25zLmRlZmF1bHROZXR3b3JrLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIHN0YXRlc1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgc3RhdGVzID0gKCkgPT4ge1xuICAgIHJldHVybiB0aGlzLl9zdGF0ZXMuYXNPYnNlcnZhYmxlKCk7XG4gIH07XG5cbiAgZ2V0TGFzdFN0YXRlcyA9ICgpID0+IHtcbiAgICByZXR1cm4gdGhpcy5fc3RhdGVzLmdldFZhbHVlKCk7XG4gIH07XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIGJlaGF2aW9yc1xuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgY29ubmVjdCA9IGFzeW5jIChpZGVudGlmaWVyPzogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgZXh0ZW5zaW9uSW5mb3MgPSBnZXRUZXJyYUV4dGVuc2lvbnMoKTtcblxuICAgIGlmIChleHRlbnNpb25JbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgW0V4dGVuc2lvblJvdXRlcl0gQ2FuJ3QgZmluZCBjb25uZWN0b3JzYCk7XG4gICAgfVxuXG4gICAgbGV0IGV4dGVuc2lvbkluZm86IEV4dGVuc2lvbkluZm8gfCB1bmRlZmluZWQ7XG5cbiAgICBpZiAoaWRlbnRpZmllcikge1xuICAgICAgZXh0ZW5zaW9uSW5mbyA9IGV4dGVuc2lvbkluZm9zLmZpbmQoXG4gICAgICAgIChpdGVtKSA9PiBpdGVtLmlkZW50aWZpZXIgPT09IGlkZW50aWZpZXIsXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAoZXh0ZW5zaW9uSW5mb3MubGVuZ3RoID09PSAxKSB7XG4gICAgICBleHRlbnNpb25JbmZvID0gZXh0ZW5zaW9uSW5mb3NbMF07XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHNlbGVjdCA9IHRoaXMub3B0aW9ucy5zZWxlY3RFeHRlbnNpb24gPz8gc2VsZWN0TW9kYWw7XG4gICAgICBjb25zdCBzZWxlY3RlZEV4dGVuc2lvbkluZm8gPSBhd2FpdCBzZWxlY3QoZXh0ZW5zaW9uSW5mb3MpO1xuXG4gICAgICBpZiAoc2VsZWN0ZWRFeHRlbnNpb25JbmZvKSB7XG4gICAgICAgIGV4dGVuc2lvbkluZm8gPSBzZWxlY3RlZEV4dGVuc2lvbkluZm87XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGV4dGVuc2lvbkluZm8pIHtcbiAgICAgIHRoaXMuY3JlYXRlQ29ubmVjdG9yKGV4dGVuc2lvbkluZm8pO1xuICAgIH1cbiAgfTtcblxuICBkaXNjb25uZWN0ID0gKCkgPT4ge1xuICAgIGNsZWFyU2Vzc2lvbigpO1xuXG4gICAgdGhpcy5fc3RhdGVzLm5leHQoe1xuICAgICAgdHlwZTogRXh0ZW5zaW9uUm91dGVyU3RhdHVzLldBTExFVF9OT1RfQ09OTkVDVEVELFxuICAgICAgbmV0d29yazogdGhpcy5vcHRpb25zLmRlZmF1bHROZXR3b3JrLFxuICAgIH0pO1xuXG4gICAgdGhpcy5fY29ubmVjdG9yPy5jbG9zZSgpO1xuICAgIHRoaXMuX2Nvbm5lY3RvciA9IG51bGw7XG4gIH07XG5cbiAgcmVxdWVzdEFwcHJvdmFsID0gKCkgPT4ge1xuICAgIGlmICghdGhpcy5fY29ubmVjdG9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tFeHRlbnNpb25Sb3V0ZXJdIE5vIGNvbm5lY3RvcicpO1xuICAgIH1cblxuICAgIHRoaXMuX2Nvbm5lY3Rvci5yZXF1ZXN0QXBwcm92YWwoKTtcbiAgfTtcblxuICByZWZldGNoU3RhdGVzID0gKCkgPT4ge1xuICAgIGlmICghdGhpcy5fY29ubmVjdG9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tFeHRlbnNpb25Sb3V0ZXJdIE5vIGNvbm5lY3RvcicpO1xuICAgIH1cblxuICAgIHRoaXMuX2Nvbm5lY3Rvci5yZWZldGNoU3RhdGVzKCk7XG4gIH07XG5cbiAgcG9zdCA9IChcbiAgICB0eDogQ3JlYXRlVHhPcHRpb25zLFxuICAgIHRlcnJhQWRkcmVzcz86IHN0cmluZyxcbiAgKTogU3Vic2NyaWJhYmxlPFdlYkV4dGVuc2lvblR4UmVzdWx0PFdlYkV4dGVuc2lvblBvc3RQYXlsb2FkPj4gPT4ge1xuICAgIGlmICghdGhpcy5fY29ubmVjdG9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tFeHRlbnNpb25Sb3V0ZXJdIE5vIGNvbm5lY3RvcicpO1xuICAgIH1cblxuICAgIGNvbnN0IGxhdGVzdFN0YXRlcyA9IHRoaXMuZ2V0TGFzdFN0YXRlcygpO1xuXG4gICAgaWYgKGxhdGVzdFN0YXRlcy50eXBlICE9PSBFeHRlbnNpb25Sb3V0ZXJTdGF0dXMuV0FMTEVUX0NPTk5FQ1RFRCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBbRXh0ZW5zaW9uUm91dGVyXSBXYWxsZXQgaXMgbm90IGNvbm5lY3RlZGApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9jb25uZWN0b3IucG9zdChcbiAgICAgIHRlcnJhQWRkcmVzcyA/PyBsYXRlc3RTdGF0ZXMud2FsbGV0LnRlcnJhQWRkcmVzcyxcbiAgICAgIHR4LFxuICAgICk7XG4gIH07XG5cbiAgc2lnbiA9IChcbiAgICB0eDogQ3JlYXRlVHhPcHRpb25zLFxuICAgIHRlcnJhQWRkcmVzcz86IHN0cmluZyxcbiAgKTogU3Vic2NyaWJhYmxlPFdlYkV4dGVuc2lvblR4UmVzdWx0PFdlYkV4dGVuc2lvblNpZ25QYXlsb2FkPj4gPT4ge1xuICAgIGlmICghdGhpcy5fY29ubmVjdG9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tFeHRlbnNpb25Sb3V0ZXJdIE5vIGNvbm5lY3RvcicpO1xuICAgIH1cblxuICAgIGNvbnN0IGxhdGVzdFN0YXRlcyA9IHRoaXMuZ2V0TGFzdFN0YXRlcygpO1xuXG4gICAgaWYgKGxhdGVzdFN0YXRlcy50eXBlICE9PSBFeHRlbnNpb25Sb3V0ZXJTdGF0dXMuV0FMTEVUX0NPTk5FQ1RFRCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBbRXh0ZW5zaW9uUm91dGVyXSBXYWxsZXQgaXMgbm90IGNvbm5lY3RlZGApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9jb25uZWN0b3Iuc2lnbihcbiAgICAgIHRlcnJhQWRkcmVzcyA/PyBsYXRlc3RTdGF0ZXMud2FsbGV0LnRlcnJhQWRkcmVzcyxcbiAgICAgIHR4LFxuICAgICk7XG4gIH07XG5cbiAgc2lnbkJ5dGVzID0gKFxuICAgIGJ5dGVzOiBCdWZmZXIsXG4gICAgdGVycmFBZGRyZXNzPzogc3RyaW5nLFxuICApOiBTdWJzY3JpYmFibGU8V2ViRXh0ZW5zaW9uVHhSZXN1bHQ8V2ViRXh0ZW5zaW9uU2lnbkJ5dGVzUGF5bG9hZD4+ID0+IHtcbiAgICBpZiAoIXRoaXMuX2Nvbm5lY3Rvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdbRXh0ZW5zaW9uUm91dGVyXSBObyBjb25uZWN0b3InKTtcbiAgICB9XG5cbiAgICBjb25zdCBsYXRlc3RTdGF0ZXMgPSB0aGlzLmdldExhc3RTdGF0ZXMoKTtcblxuICAgIGlmIChsYXRlc3RTdGF0ZXMudHlwZSAhPT0gRXh0ZW5zaW9uUm91dGVyU3RhdHVzLldBTExFVF9DT05ORUNURUQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgW0V4dGVuc2lvblJvdXRlcl0gV2FsbGV0IGlzIG5vdCBjb25uZWN0ZWRgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fY29ubmVjdG9yLnNpZ25CeXRlcyhcbiAgICAgIHRlcnJhQWRkcmVzcyA/PyBsYXRlc3RTdGF0ZXMud2FsbGV0LnRlcnJhQWRkcmVzcyxcbiAgICAgIGJ5dGVzLFxuICAgICk7XG4gIH07XG5cbiAgaGFzQ1cyMFRva2VucyA9IChcbiAgICBjaGFpbklEOiBzdHJpbmcsXG4gICAgLi4udG9rZW5BZGRyczogc3RyaW5nW11cbiAgKTogUHJvbWlzZTx7IFt0b2tlbkFkZHI6IHN0cmluZ106IGJvb2xlYW4gfT4gPT4ge1xuICAgIGlmICghdGhpcy5fY29ubmVjdG9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tFeHRlbnNpb25Sb3V0ZXJdIE5vIGNvbm5lY3RvcicpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5fY29ubmVjdG9yIGluc3RhbmNlb2YgTGVnYWN5RXh0ZW5zaW9uQ29ubmVjdG9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdbRXh0ZW5zaW9uUm91dGVyXSBMZWdhY3kgZXh0ZW5zaW9uIGRvZXMgbm90IHN1cHBvcnQgaGFzQ1cyMFRva2VucygpICcsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9jb25uZWN0b3IuaGFzQ1cyMFRva2VucyhjaGFpbklELCAuLi50b2tlbkFkZHJzKTtcbiAgfTtcblxuICBhZGRDVzIwVG9rZW5zID0gKFxuICAgIGNoYWluSUQ6IHN0cmluZyxcbiAgICAuLi50b2tlbkFkZHJzOiBzdHJpbmdbXVxuICApOiBQcm9taXNlPHsgW3Rva2VuQWRkcjogc3RyaW5nXTogYm9vbGVhbiB9PiA9PiB7XG4gICAgaWYgKCF0aGlzLl9jb25uZWN0b3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignW0V4dGVuc2lvblJvdXRlcl0gTm8gY29ubmVjdG9yJyk7XG4gICAgfSBlbHNlIGlmICh0aGlzLl9jb25uZWN0b3IgaW5zdGFuY2VvZiBMZWdhY3lFeHRlbnNpb25Db25uZWN0b3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1tFeHRlbnNpb25Sb3V0ZXJdIExlZ2FjeSBleHRlbnNpb24gZG9lcyBub3Qgc3VwcG9ydCBhZGRDVzIwVG9rZW5zKCkgJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rvci5hZGRDVzIwVG9rZW5zKGNoYWluSUQsIC4uLnRva2VuQWRkcnMpO1xuICB9O1xuXG4gIGhhc05ldHdvcmsgPSAoXG4gICAgbmV0d29yazogT21pdDxXZWJFeHRlbnNpb25OZXR3b3JrSW5mbywgJ25hbWUnPixcbiAgKTogUHJvbWlzZTxib29sZWFuPiA9PiB7XG4gICAgaWYgKCF0aGlzLl9jb25uZWN0b3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignW0V4dGVuc2lvblJvdXRlcl0gTm8gY29ubmVjdG9yJyk7XG4gICAgfSBlbHNlIGlmICh0aGlzLl9jb25uZWN0b3IgaW5zdGFuY2VvZiBMZWdhY3lFeHRlbnNpb25Db25uZWN0b3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1tFeHRlbnNpb25Sb3V0ZXJdIExlZ2FjeSBleHRlbnNpb24gZG9lcyBub3Qgc3VwcG9ydCBoYXNOZXR3b3JrKCkgJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rvci5oYXNOZXR3b3JrKG5ldHdvcmspO1xuICB9O1xuXG4gIGFkZE5ldHdvcmsgPSAobmV0d29yazogV2ViRXh0ZW5zaW9uTmV0d29ya0luZm8pOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgICBpZiAoIXRoaXMuX2Nvbm5lY3Rvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdbRXh0ZW5zaW9uUm91dGVyXSBObyBjb25uZWN0b3InKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuX2Nvbm5lY3RvciBpbnN0YW5jZW9mIExlZ2FjeUV4dGVuc2lvbkNvbm5lY3Rvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnW0V4dGVuc2lvblJvdXRlcl0gTGVnYWN5IGV4dGVuc2lvbiBkb2VzIG5vdCBzdXBwb3J0IGFkZE5ldHdvcmsoKSAnLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5fY29ubmVjdG9yLmFkZE5ldHdvcmsobmV0d29yayk7XG4gIH07XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIGludGVybmFsXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICBwcml2YXRlIGNyZWF0ZUNvbm5lY3RvciA9IChleHRlbnNpb25JbmZvOiBFeHRlbnNpb25JbmZvKSA9PiB7XG4gICAgdGhpcy5fY29ubmVjdG9yPy5jbG9zZSgpO1xuXG4gICAgaWYgKCFleHRlbnNpb25JbmZvLmNvbm5lY3RvciAmJiAhdGhpcy5pc0Rlc2t0b3BDaHJvbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFtFeHRlbnNpb25Sb3V0ZXJdIExlZ2FjeSBleHRlbnNpb24gb25seSBzdXBwb3J0IHRoZSBkZXNrdG9wIGNocm9tZWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbm5lY3RvclByb21pc2U6IFByb21pc2U8VGVycmFXZWJFeHRlbnNpb25Db25uZWN0b3I+ID1cbiAgICAgIGV4dGVuc2lvbkluZm8uY29ubmVjdG9yXG4gICAgICAgID8gUHJvbWlzZS5yZXNvbHZlKGV4dGVuc2lvbkluZm8uY29ubmVjdG9yKCkpXG4gICAgICAgIDogUHJvbWlzZS5yZXNvbHZlKFxuICAgICAgICAgICAgbmV3IExlZ2FjeUV4dGVuc2lvbkNvbm5lY3RvcihleHRlbnNpb25JbmZvLmlkZW50aWZpZXIpLFxuICAgICAgICAgICk7XG5cbiAgICBjb25uZWN0b3JQcm9taXNlLnRoZW4oKGNvbm5lY3RvcikgPT4ge1xuICAgICAgY29ubmVjdG9yLm9wZW4odGhpcy5vcHRpb25zLmhvc3RXaW5kb3cgPz8gd2luZG93LCB7XG4gICAgICAgIG5leHQ6IChuZXh0U3RhdGVzOiBXZWJFeHRlbnNpb25TdGF0ZXMpID0+IHtcbiAgICAgICAgICBpZiAobmV4dFN0YXRlcy50eXBlID09PSBXZWJFeHRlbnNpb25TdGF0dXMuSU5JVElBTElaSU5HKSB7XG4gICAgICAgICAgICB0aGlzLl9zdGF0ZXMubmV4dCh7XG4gICAgICAgICAgICAgIHR5cGU6IEV4dGVuc2lvblJvdXRlclN0YXR1cy5JTklUSUFMSVpJTkcsXG4gICAgICAgICAgICAgIG5ldHdvcms6IHRoaXMub3B0aW9ucy5kZWZhdWx0TmV0d29yayxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSBpZiAobmV4dFN0YXRlcy50eXBlID09PSBXZWJFeHRlbnNpb25TdGF0dXMuTk9fQVZBSUxBQkxFKSB7XG4gICAgICAgICAgICB0aGlzLl9zdGF0ZXMubmV4dCh7XG4gICAgICAgICAgICAgIHR5cGU6IEV4dGVuc2lvblJvdXRlclN0YXR1cy5OT19BVkFJTEFCTEUsXG4gICAgICAgICAgICAgIG5ldHdvcms6IHRoaXMub3B0aW9ucy5kZWZhdWx0TmV0d29yayxcbiAgICAgICAgICAgICAgaXNDb25uZWN0b3JFeGlzdHM6IHRydWUsXG4gICAgICAgICAgICAgIGlzQXBwcm92ZWQ6IG5leHRTdGF0ZXMuaXNBcHByb3ZlZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSBpZiAobmV4dFN0YXRlcy53YWxsZXRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5fc3RhdGVzLm5leHQoe1xuICAgICAgICAgICAgICB0eXBlOiBFeHRlbnNpb25Sb3V0ZXJTdGF0dXMuV0FMTEVUX05PVF9DT05ORUNURUQsXG4gICAgICAgICAgICAgIG5ldHdvcms6IG5leHRTdGF0ZXMubmV0d29yayxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLl9zdGF0ZXMubmV4dCh7XG4gICAgICAgICAgICAgIHR5cGU6IEV4dGVuc2lvblJvdXRlclN0YXR1cy5XQUxMRVRfQ09OTkVDVEVELFxuICAgICAgICAgICAgICBuZXR3b3JrOiBuZXh0U3RhdGVzLm5ldHdvcmssXG4gICAgICAgICAgICAgIHdhbGxldDogbmV4dFN0YXRlcy5mb2N1c2VkV2FsbGV0QWRkcmVzc1xuICAgICAgICAgICAgICAgID8gbmV4dFN0YXRlcy53YWxsZXRzLmZpbmQoXG4gICAgICAgICAgICAgICAgICAgIChpdGVtV2FsbGV0KSA9PlxuICAgICAgICAgICAgICAgICAgICAgIGl0ZW1XYWxsZXQudGVycmFBZGRyZXNzID09PVxuICAgICAgICAgICAgICAgICAgICAgIG5leHRTdGF0ZXMuZm9jdXNlZFdhbGxldEFkZHJlc3MsXG4gICAgICAgICAgICAgICAgICApID8/IG5leHRTdGF0ZXMud2FsbGV0c1swXVxuICAgICAgICAgICAgICAgIDogbmV4dFN0YXRlcy53YWxsZXRzWzBdLFxuICAgICAgICAgICAgICBjb25uZWN0b3JUeXBlOlxuICAgICAgICAgICAgICAgIGNvbm5lY3RvciBpbnN0YW5jZW9mIExlZ2FjeUV4dGVuc2lvbkNvbm5lY3RvclxuICAgICAgICAgICAgICAgICAgPyBFeHRlbnNpb25Sb3V0ZXJDb25uZWN0b3JUeXBlLkxFR0FDWVxuICAgICAgICAgICAgICAgICAgOiBFeHRlbnNpb25Sb3V0ZXJDb25uZWN0b3JUeXBlLldFQl9FWFRFTlNJT04sXG4gICAgICAgICAgICAgIHN1cHBvcnRGZWF0dXJlczogbmV3IFNldChjb25uZWN0b3Iuc3VwcG9ydEZlYXR1cmVzKCkpLFxuICAgICAgICAgICAgICBleHRlbnNpb25JbmZvLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBlcnJvcjogKGVycm9yKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIH0sXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiB7fSxcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLl9jb25uZWN0b3IgPSBjb25uZWN0b3I7XG5cbiAgICAgIHN0b3JlU2Vzc2lvbih7XG4gICAgICAgIGlkZW50aWZpZXI6IGV4dGVuc2lvbkluZm8uaWRlbnRpZmllcixcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9O1xufVxuIl19